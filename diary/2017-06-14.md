
# M1 Database
:REVIEW-2017:
Completed SQL query to pull together all employee training tables.

```sql
-- Putting it all together....
SELECT utdEmployeeID, utoLineName, utoDescription, utoMethodOperation, utoMethodRevision, utcTrainingType, utdTrainingDate, Interval, NextDue, WorkedRecently FROM
(
    ----------------------------------------------------------------------------
    -- Get most recent method revisions on the production line.
    ----------------------------------------------------------------------------
    SELECT imrPartRevisionID, uimrProductionLine FROM
    (
        SELECT SUBSTRING(jmpPartID, 1, 2) AS Line, jmpPartRevisionID FROM JOBS
            WHERE
                jmpCreatedDate >= DATEADD(week,-2,GETDATE())
                AND jmpClosedDate is Null
                AND jmpPartRevisionID like '%OPERATOR'
            GROUP BY SUBSTRING(jmpPartID, 1, 2), jmpPartRevisionID
    ) AS revs
    Inner Join PartRevisions
    ON
        revs.jmpPartRevisionID = imrPartRevisionID
        AND Line =  SUBSTRING(imrPartID, 1, 2)
    GROUP BY imrPartRevisionID, uimrProductionLine
) AS methods
LEFT JOIN (
    ----------------------------------------------------------------------------
    -- Get most recent station/revision training for each current employee
    -- Calculate the next required training date based on the training
    -- schedule table.
    ----------------------------------------------------------------------------
    SELECT A.utdTrainingID, A.utdEmployeeID, utoDescription, utoMethodOperation, utcTrainingType, A.utdJobOperationID, A.utdTrainingDate, 'Every ' + LTRIM(str(A.utsIntervalMultiplier)) + ' ' + uiuName AS 'Interval', utoLineName, utoMethodRevision,
        CASE
            WHEN RTRIM(uiuName) = 'Day' and A.utdTrainingID is not Null THEN
                DATEADD(weekday, A.utsIntervalMultiplier, A.utdTrainingDate)
            WHEN RTRIM(uiuName) = 'Week' and A.utdTrainingID is not Null THEN
                DATEADD(week, A.utsIntervalMultiplier, A.utdTrainingDate)
            WHEN RTRIM(uiuName) = 'Month' and A.utdTrainingID is not Null THEN
                DATEADD(month, A.utsIntervalMultiplier, A.utdTrainingDate)
            WHEN RTRIM(uiuName) = 'Quarter' and A.utdTrainingID is not Null THEN
                DATEADD(quarter, A.utsIntervalMultiplier, A.utdTrainingDate)
            WHEN RTRIM(uiuName) = 'Year' and A.utdTrainingID is not Null THEN
                DATEADD(year, A.utsIntervalMultiplier, A.utdTrainingDate)
            WHEN A.utdTrainingID is Null THEN
                DATEADD(dd, 0, DATEDIFF(dd, 0, GETDATE()))
        END AS NextDue
    FROM (
        SELECT utdEmployeeID, utdJobOperationID, utdTrainingCategoryID, utsIntervalUnitID, utsIntervalMultiplier, utsStationID, utdTrainingID, utdTrainingDate FROM uTrainingData
        JOIN uTrainingSchedule
        ON utdTrainingCategoryID = utsTrainingCategoryID
        WHERE utdTrainingID in (
            SELECT MAX(utdTrainingID)
            FROM uTrainingData
            GROUP BY utdEmployeeID, utdJobOperationID, utdTrainingCategoryID
        )
    ) AS A
    LEFT JOIN (
        SELECT utsStationID, utdEmployeeID, utdJobOperationID, utdTrainingCategoryID FROM uTrainingData
        JOIN uTrainingSchedule
        ON
            utdTrainingCategoryID = utsTrainingCategoryID
            AND utsStationID = utdJobOperationID
        WHERE utdTrainingID in (
            SELECT MAX(utdTrainingID)
            FROM uTrainingData
            GROUP BY utdEmployeeID, utdJobOperationID, utdTrainingCategoryID
        )
    ) AS B
    ON
        A.utdEmployeeID LIKE B.utdEmployeeID
        AND A.utdTrainingCategoryID =  B.utdTrainingCategoryID
        AND A.utdJobOperationID =  B.utdJobOperationID
    INNER JOIN uIntervalUnits
        ON uiuUnitID = A.utsIntervalUnitID
    INNER JOIN uTrainingOperations
        ON A.utdJobOperationID = utoStationID
    INNER JOIN uTrainingCategories
        ON utcCategoryID = A.utdTrainingCategoryID
    INNER JOIN Employees
        ON A.utdEmployeeID = lmeEmployeeID
    WHERE A.utsStationID = ISNULL(B.utsStationID, 0)
        AND lmeTerminationDate IS NULL
) AS training
ON
    methods.imrPartRevisionID = training.utoMethodRevision
    AND methods.uimrProductionLine = training.utoLineName
LEFT JOIN (
    ----------------------------------------------------------------------------
    -- Find employees that have worked in their trained stations within
    -- the past 3 weeks.
    ----------------------------------------------------------------------------
    SELECT lmlEmployeeID, lmlJobOperationID, jmpPartRevisionID,
        CASE WHEN lmlEmployeeID IS NOT NULL THEN 'True' ELSE 'False' END AS WorkedRecently
    FROM Timecardlines
    INNER JOIN Jobs
    ON lmlJobID = jmpJobID
    WHERE
        lmlCreatedDate >= DATEADD(week, -3, GETDATE())
        AND jmpPartRevisionID like '%OPERATOR%'
    GROUP BY  lmlEmployeeID, lmlJobOperationID, jmpPartRevisionID
) AS work
ON
    training.utoMethodOperation = work.lmlJobOperationID
    AND training.utoMethodRevision = work.jmpPartRevisionID
    AND training.utdEmployeeID = work.lmlEmployeeID
```
